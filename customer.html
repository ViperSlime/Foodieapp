<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    header {
      background-color: #ff8c42;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .filter-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      background: #f0f0f0;
      transition: all 0.3s;
    }
    .filter-btn.active {
      background: #ff8c42;
      color: white;
    }
    .filter-btn.favorites {
      background: #ff6b81;
      color: white;
    }
    .restaurant-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .restaurant-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .restaurant-actions {
      display: flex;
      gap: 10px;
    }
    .restaurant-categories {
      display: flex;
      gap: 8px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .category-tag {
      padding: 4px 10px;
      background: #f0f0f0;
      border-radius: 20px;
      font-size: 0.8em;
    }
    .menu-btn, .review-btn {
      background: #ff8c42;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .menu-btn:hover, .review-btn:hover {
      opacity: 0.9;
    }
    .favorite-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .favorite-btn.favorited {
      background: #576574;
    }
    .reviews-container {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }
    .review {
      padding: 15px;
      margin: 10px 0;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .review-owner-reply {
      margin-left: 30px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 8px;
      font-style: italic;
    }
    .menu-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .menu-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-menu {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .menu-category {
      margin-top: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .menu-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed #eee;
      align-items: center;
    }
    .menu-item-info {
      flex: 1;
    }
    .menu-item-name {
      font-weight: bold;
    }
    .menu-item-price {
      color: #ff8c42;
      font-weight: bold;
    }
    .menu-item-desc {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }
    .menu-item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      margin-left: 15px;
    }
    .quantity-control {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .quantity-btn {
      width: 25px;
      height: 25px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .quantity-input {
      width: 40px;
      text-align: center;
      margin: 0 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    .add-to-cart {
      background: #ff8c42;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    .order-summary {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .order-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .order-total {
      font-weight: bold;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }
    .checkout-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      width: 100%;
      cursor: pointer;
      margin-top: 15px;
    }
    .review-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .review-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }
    .rating-stars {
      display: flex;
      gap: 5px;
      margin: 10px 0;
    }
    .star {
      font-size: 24px;
      cursor: pointer;
      color: #ddd;
    }
    .star.selected {
      color: #ff8c42;
    }
  </style>
</head>
<body class="customer">
  <header>
    <h1>Find Restaurants</h1>
  </header>

  <main>
    <section class="card">
      <h2>Filter Restaurants</h2>
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn favorites" data-filter="favorites">Favorites</button>
        <button class="filter-btn" data-filter="halal">Halal</button>
        <button class="filter-btn" data-filter="healthy">Healthy</button>
        <button class="filter-btn" data-filter="vegan">Vegan</button>
        <button class="filter-btn" data-filter="vegetarian">Vegetarian</button>
        <button class="filter-btn" data-filter="beverages">Beverages</button>
        <button class="filter-btn" data-filter="fast-food">Fast Food</button>
      </div>
    </section>

    <section id="restaurant-list" class="card">
      <h2>Available Restaurants</h2>
      <div id="restaurants-container">
        <!-- Will be populated by JavaScript -->
      </div>
    </section>
  </main>

  <!-- Enhanced Menu Modal -->
  <div id="menuModal" class="menu-modal">
    <div class="menu-content">
      <span class="close-menu" onclick="closeModal('menuModal')">&times;</span>
      <h2 id="menuRestaurantName">Restaurant Name</h2>
      <p id="menuRestaurantLocation">Location</p>
      <div id="menuItemsContainer"></div>
      
      <!-- Order Summary Section -->
      <div class="order-summary">
        <h3 class="order-title">Your Order</h3>
        <div id="orderItemsContainer">
          <p>No items added yet</p>
        </div>
        <div id="orderTotal" class="order-total">
          Total: 
        </div>
        <button class="checkout-btn" onclick="checkout()">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" class="review-modal">
    <div class="review-content card">
      <span class="close-menu" onclick="closeModal('reviewModal')">&times;</span>
      <h2>Add Review</h2>
      <p>For: <span id="reviewRestaurantName"></span></p>
      <div class="rating-stars">
        <span class="star" onclick="setRating(1)">★</span>
        <span class="star" onclick="setRating(2)">★</span>
        <span class="star" onclick="setRating(3)">★</span>
        <span class="star" onclick="setRating(4)">★</span>
        <span class="star" onclick="setRating(5)">★</span>
      </div>
      <textarea id="reviewText" placeholder="Write your review..." rows="4"></textarea>
      <button onclick="submitReview()" class="btn btn-primary">Submit Review</button>
    </div>
  </div>

  <script>
    // Current state
    let currentFilter = 'all';
    let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
    let favorites = JSON.parse(localStorage.getItem('favorites')) || {};
    let currentRating = 0;
    let currentRestaurantForReview = null;
    let currentOrder = {};
    let currentRestaurantForMenu = null;

    // Sample restaurant data with proper prices
    const sampleRestaurants = [
      {
        id: 'rest1',
        name: 'Italian Bistro',
        location: '123 Main St',
        description: 'Authentic Italian cuisine with homemade pasta',
        categories: ['italian', 'pasta'],
        status: 'approved',
        menu: [
          {
            id: 'item1',
            name: 'Margherita Pizza',
            description: 'Classic pizza with tomato sauce and mozzarella',
            price: 12.99,
            category: 'Main Courses',
            image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'
          },
          {
            id: 'item2',
            name: 'Spaghetti Carbonara',
            description: 'Pasta with eggs, cheese, pancetta, and black pepper',
            price: 14.99,
            category: 'Main Courses',
            image: 'https://images.unsplash.com/photo-1555949258-eb67b1ef0ceb?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'
          },
          {
            id: 'item3',
            name: 'Tiramisu',
            description: 'Classic Italian dessert with coffee flavor',
            price: 6.99,
            category: 'Desserts',
            image: 'https://images.unsplash.com/photo-1550614000-4895a10e1bfd?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'
          }
        ],
        reviews: [],
        owner: 'owner@example.com'
      },
      {
        id: 'rest2',
        name: 'Burger Palace',
        location: '456 Oak Ave',
        description: 'Gourmet burgers and fries',
        categories: ['fast-food', 'burgers'],
        status: 'approved',
        menu: [
          {
            id: 'item4',
            name: 'Classic Burger',
            description: 'Beef patty with lettuce, tomato and special sauce',
            price: 8.99,
            category: 'Burgers',
            image: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'
          },
          {
            id: 'item5',
            name: 'Cheese Fries',
            description: 'Crispy fries with melted cheese',
            price: 4.99,
            category: 'Sides',
            image: 'https://images.unsplash.com/photo-1541592106381-b31e9677c0e5?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'
          }
        ],
        reviews: [],
        owner: 'owner@example.com'
      }
    ];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize favorites for current user if not exists
      if (currentUser && !favorites[currentUser.email]) {
        favorites[currentUser.email] = [];
        localStorage.setItem('favorites', JSON.stringify(favorites));
      }
      
      // Load sample data if no restaurants exist
      const restaurants = JSON.parse(localStorage.getItem('restaurants')) || sampleRestaurants;
      if (restaurants.length === 0) {
        localStorage.setItem('restaurants', JSON.stringify(sampleRestaurants));
      }
      
      loadRestaurants();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.dataset.filter;
          loadRestaurants();
        });
      });
    }

    function loadRestaurants() {
      try {
        const restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
        
        // Filter based on status first (only approved and not removed)
        let filtered = restaurants.filter(r => 
          r && r.status === 'approved' && !r.removed
        );

        // Apply additional filters
        if (currentFilter === 'favorites') {
          if (!currentUser) {
            alert('Please login to view favorites');
            return;
          }
          const userFavorites = favorites[currentUser.email] || [];
          filtered = filtered.filter(r => userFavorites.includes(r.id));
        } 
        else if (currentFilter !== 'all') {
          filtered = filtered.filter(r => 
            r.categories && r.categories.includes(currentFilter)
          );
        }

        displayRestaurants(filtered);
      } catch (e) {
        console.error("Error loading restaurants:", e);
        document.getElementById('restaurants-container').innerHTML = 
          '<p>Error loading restaurant data. Please try again.</p>';
      }
    }

    function displayRestaurants(restaurants) {
      const container = document.getElementById('restaurants-container');
      
      if (restaurants.length === 0) {
        container.innerHTML = '<p>No restaurants found matching your criteria.</p>';
        return;
      }

      container.innerHTML = restaurants.map(restaurant => {
        const isFavorite = currentUser && 
                          favorites[currentUser.email] && 
                          favorites[currentUser.email].includes(restaurant.id);
        
        return `
          <div class="restaurant-card" data-id="${restaurant.id}">
            <div class="restaurant-header">
              <h3>${restaurant.name || 'Unnamed Restaurant'}</h3>
              <div class="restaurant-actions">
                ${currentUser ? `
                  <button class="favorite-btn ${isFavorite ? 'favorited' : ''}" 
                    onclick="toggleFavorite('${restaurant.id}', this)">
                    ${isFavorite ? '❤️ Favorited' : '♡ Favorite'}
                  </button>
                ` : ''}
                <button class="menu-btn" onclick="showMenu('${restaurant.id}')">View Menu</button>
                ${currentUser ? `
                  <button class="review-btn" onclick="showReviewModal('${restaurant.id}')">Add Review</button>
                ` : ''}
              </div>
            </div>
            <p>${restaurant.location || 'No address provided'}</p>
            <p>${restaurant.description || 'No description available'}</p>
            <div class="restaurant-categories">
              ${restaurant.categories ? restaurant.categories.map(cat => `
                <span class="category-tag">${cat}</span>
              `).join('') : ''}
            </div>
            <div class="reviews-container">
              <h4>Reviews</h4>
              ${restaurant.reviews && restaurant.reviews.length > 0 ? 
                restaurant.reviews.slice(0, 3).map(review => `
                  <div class="review">
                    <p><strong>${review.user || 'Anonymous'}</strong> ${'★'.repeat(review.rating || 0)}</p>
                    <p>${review.text || 'No review text'}</p>
                    ${review.reply ? `
                      <div class="review-owner-reply">
                        <strong>Owner response:</strong>
                        <p>${review.reply}</p>
                      </div>
                    ` : ''}
                  </div>
                `).join('') : '<p>No reviews yet</p>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleFavorite(restaurantId, buttonElement) {
      if (!currentUser) {
        alert('Please login to add favorites');
        return;
      }

      // Initialize user's favorites if not exists
      if (!favorites[currentUser.email]) {
        favorites[currentUser.email] = [];
      }

      // Toggle favorite status
      const index = favorites[currentUser.email].indexOf(restaurantId);
      if (index === -1) {
        favorites[currentUser.email].push(restaurantId);
      } else {
        favorites[currentUser.email].splice(index, 1);
      }

      // Save to localStorage
      localStorage.setItem('favorites', JSON.stringify(favorites));
      
      // Update button appearance
      if (buttonElement) {
        const isNowFavorite = favorites[currentUser.email].includes(restaurantId);
        buttonElement.classList.toggle('favorited', isNowFavorite);
        buttonElement.innerHTML = isNowFavorite ? '❤️ Favorited' : '♡ Favorite';
      }
      
      // Update display if we're on favorites filter
      if (currentFilter === 'favorites') {
        loadRestaurants();
      }
    }

    function showMenu(restaurantId) {
      try {
        const restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
        const restaurant = restaurants.find(r => r && r.id === restaurantId);
        
        if (!restaurant) {
          alert('Restaurant not found in our records');
          return;
        }

        currentRestaurantForMenu = restaurantId;
        currentOrder = {};
        document.getElementById('menuRestaurantName').textContent = restaurant.name || 'Unnamed Restaurant';
        document.getElementById('menuRestaurantLocation').textContent = restaurant.location || 'Location not specified';
        
        const menuContainer = document.getElementById('menuItemsContainer');
        menuContainer.innerHTML = '';
        
        if (restaurant.menu && Array.isArray(restaurant.menu)) {
          const menuByCategory = {};
          
          restaurant.menu.forEach(item => {
            if (!item || typeof item !== 'object') return;
            
            const category = item.category || 'Other';
            if (!menuByCategory[category]) {
              menuByCategory[category] = [];
            }
            
            const validItem = {
              id: item.id || Math.random().toString(36).substr(2, 9),
              name: item.name || 'Unnamed Item',
              description: item.description || '',
              price: typeof item.price === 'number' ? item.price : 0,
              image: item.image || 'https://via.placeholder.com/80'
            };
            
            menuByCategory[category].push(validItem);
          });
          
          for (const category in menuByCategory) {
            if (menuByCategory[category].length === 0) continue;
            
            const categoryHTML = document.createElement('div');
            categoryHTML.className = 'menu-category';
            categoryHTML.innerHTML = `<h3>${category}</h3>`;
            
            menuByCategory[category].forEach(item => {
              const itemHTML = document.createElement('div');
              itemHTML.className = 'menu-item';
              itemHTML.innerHTML = `
                <div class="menu-item-info">
                  <div class="menu-item-name">${item.name}</div>
                  ${item.description ? `<div class="menu-item-desc">${item.description}</div>` : ''}
                 <div class="menu-item-price">${formatPrice(item.price)}</div>
                  <div class="quantity-control">
                    <button class="quantity-btn" onclick="adjustQuantity('${item.id}', -1)">-</button>
                    <input type="number" class="quantity-input" id="qty-${item.id}" value="0" min="0">
                    <button class="quantity-btn" onclick="adjustQuantity('${item.id}', 1)">+</button>
                    <button class="add-to-cart" onclick="addToCart('${item.id}')">Add to Cart</button>
                  </div>
                </div>
                <img src="${item.image}" class="menu-item-image" alt="${item.name}">
              `;
              categoryHTML.appendChild(itemHTML);
            });
            
            menuContainer.appendChild(categoryHTML);
          }
        } else {
          menuContainer.innerHTML = '<p>No menu available for this restaurant.</p>';
        }
        function formatPrice(price) {
  // Handle null/undefined/empty string
  if (price === null || price === undefined || price === '') return '$0.00';
  
  // Remove any existing dollar signs or commas
  const cleanPrice = String(price).replace(/[$,]/g, '');
  
  // Convert to number and format
  const numberPrice = parseFloat(cleanPrice);
  return isNaN(numberPrice) ? '$0.00' : `$${numberPrice.toFixed(2)}`;
}
        updateOrderSummary();
        document.getElementById('menuModal').style.display = 'flex';
      } catch (error) {
        console.error("Error displaying menu:", error);
        alert('Failed to load menu. Please try again.');
      }
    }

    function adjustQuantity(itemId, change) {
      const input = document.getElementById(`qty-${itemId}`);
      let newValue = parseInt(input.value) + change;
      newValue = Math.max(0, newValue);
      input.value = newValue;
    }

    function addToCart(itemId) {
      const restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
      const restaurant = restaurants.find(r => r && r.id === currentRestaurantForMenu);
      
      if (!restaurant) {
        alert('Restaurant not found');
        return;
      }
      
      const menuItem = restaurant.menu.find(item => item && item.id === itemId);
      const quantityInput = document.getElementById(`qty-${itemId}`);
      const quantity = parseInt(quantityInput.value);
      
      if (!menuItem) {
        alert('Menu item not found');
        return;
      }
      
      if (quantity <= 0) {
        alert('Please select at least 1 item');
        return;
      }
      
      if (!currentOrder[itemId]) {
        currentOrder[itemId] = {
          name: menuItem.name,
          price: menuItem.price,
          quantity: 0
        };
      }
      
      currentOrder[itemId].quantity += quantity;
      quantityInput.value = 0;
      updateOrderSummary();
      alert(`${quantity} ${menuItem.name} added to cart!`);
    }

    function updateOrderSummary() {
      const orderContainer = document.getElementById('orderItemsContainer');
      orderContainer.innerHTML = '';
      
      let hasItems = false;
      let total = 0;
      
      for (const itemId in currentOrder) {
        const item = currentOrder[itemId];
        
        if (item.quantity > 0) {
          hasItems = true;
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          
          const itemElement = document.createElement('div');
          itemElement.className = 'order-item';
          itemElement.innerHTML = `
            <span>${item.quantity}x ${item.name}</span>
            <span>$${itemTotal.toFixed(2)}</span>
          `;
          orderContainer.appendChild(itemElement);
        }
      }
      
      if (!hasItems) {
        orderContainer.innerHTML = '<p>No items added yet</p>';
      }
      
      document.getElementById('orderTotal').textContent = `Total: $${total.toFixed(2)}`;
    }

    function checkout() {
      if (Object.keys(currentOrder).length === 0 || 
          Object.values(currentOrder).every(item => item.quantity === 0)) {
        alert('Your cart is empty');
        return;
      }
      
      // Get restaurant and user info
      const restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
      const restaurant = restaurants.find(r => r && r.id === currentRestaurantForMenu);
      const user = JSON.parse(localStorage.getItem('currentUser'));
      
      if (!restaurant) {
        alert('Restaurant not found');
        return;
      }
      
      if (!user) {
        alert('Please login to place an order');
        return;
      }
      
      // Create order object
      const order = {
        id: Date.now().toString(),
        restaurantId: restaurant.id,
        restaurantName: restaurant.name,
        customerEmail: user.email,
        items: [],
        total: calculateOrderTotal(),
        status: 'pending',
        orderDate: new Date().toISOString()
      };
      
      // Add items to order
      for (const itemId in currentOrder) {
        const item = currentOrder[itemId];
        if (item.quantity > 0) {
          order.items.push({
            id: itemId,
            name: item.name,
            price: item.price,
            quantity: item.quantity
          });
        }
      }
      
      // Add order to restaurant's orders
      const restaurantIndex = restaurants.findIndex(r => r.id === restaurant.id);
      if (restaurantIndex !== -1) {
        if (!restaurants[restaurantIndex].orders) {
          restaurants[restaurantIndex].orders = [];
        }
        restaurants[restaurantIndex].orders.push(order);
        localStorage.setItem('restaurants', JSON.stringify(restaurants));
      }
      
      // Create notification for owner
      const notifications = JSON.parse(localStorage.getItem('notifications')) || [];
      notifications.push({
        recipient: restaurant.owner,
        type: 'new-order',
        restaurantId: restaurant.id,
        restaurantName: restaurant.name,
        orderId: order.id,
        total: order.total,
        date: new Date().toISOString(),
        read: false
      });
      localStorage.setItem('notifications', JSON.stringify(notifications));
      
      // Show confirmation
      alert(`Order placed successfully! Total: $${order.total.toFixed(2)}`);
      
      // Clear the order
      currentOrder = {};
      updateOrderSummary();
      
      // Close the modal
      closeModal('menuModal');
    }

    function calculateOrderTotal() {
      let total = 0;
      
      for (const itemId in currentOrder) {
        const item = currentOrder[itemId];
        total += item.price * item.quantity;
      }
      
      return total;
    }

    function showReviewModal(restaurantId) {
      if (!currentUser) {
        alert('Please login to add reviews');
        return;
      }
      
      const restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
      const restaurant = restaurants.find(r => r && r.id === restaurantId);
      
      if (restaurant) {
        currentRestaurantForReview = restaurantId;
        document.getElementById('reviewRestaurantName').textContent = restaurant.name || 'Unnamed Restaurant';
        document.getElementById('reviewModal').style.display = 'flex';
      } else {
        alert('Restaurant not found');
      }
    }

    function setRating(rating) {
      currentRating = rating;
      const stars = document.querySelectorAll('.rating-stars .star');
      stars.forEach((star, index) => {
        star.classList.toggle('selected', index < rating);
      });
    }

    function submitReview() {
      const reviewText = document.getElementById('reviewText').value.trim();
      if (!reviewText) {
        alert('Please write a review before submitting');
        return;
      }
      
      if (currentRating === 0) {
        alert('Please select a rating');
        return;
      }
      
      const restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
      const restaurantIndex = restaurants.findIndex(r => r && r.id === currentRestaurantForReview);
      
      if (restaurantIndex !== -1) {
        // Initialize reviews array if it doesn't exist
        if (!restaurants[restaurantIndex].reviews) {
          restaurants[restaurantIndex].reviews = [];
        }
        
        // Add new review
        restaurants[restaurantIndex].reviews.unshift({
          user: currentUser.email,
          rating: currentRating,
          text: reviewText,
          date: new Date().toISOString(),
          reply: null
        });
        
        // Save back to localStorage
        localStorage.setItem('restaurants', JSON.stringify(restaurants));
        
        // Create notification for owner
        const notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        notifications.push({
          recipient: restaurants[restaurantIndex].owner,
          type: 'new-review',
          restaurantId: currentRestaurantForReview,
          restaurantName: restaurants[restaurantIndex].name,
          reviewText: reviewText,
          date: new Date().toISOString(),
          read: false
        });
        localStorage.setItem('notifications', JSON.stringify(notifications));
        
        // Close modal and reset
        closeModal('reviewModal');
        document.getElementById('reviewText').value = '';
        currentRating = 0;
        document.querySelectorAll('.rating-stars .star').forEach(star => {
          star.classList.remove('selected');
        });
        
        // Refresh display
        loadRestaurants();
      } else {
        alert('Restaurant not found');
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('menu-modal')) {
        closeModal('menuModal');
      }
      if (event.target.classList.contains('review-modal')) {
        closeModal('reviewModal');
      }
    }
  </script>
  <script src="js/navigation.js"></script>
  <script src="js/customer.js"></script>
  
</body>
</html>

